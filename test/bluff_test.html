<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Test suite for "Bluff it"</title>
  	<script src="http://js.local/jquery/jquery-1.2.6.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="http://js.local/qunit/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="http://js.local/qunit/qunit.js"></script>
    <script type="text/javascript" src="http://js.local/bluff/number.js"></script>
    <script type="text/javascript" src="http://js.local/bluff/object.js"></script>
    <script type="application/javascript">
      var dice = {
        roll : function() {
          return 1;
        }
      }

      var roll = {
        ROLLS : ["32", "41", "42", "43", "51", "52", "53", "54", "61", "62", "63", "64", "65",
                 "11", "22", "33", "44", "55", "66", "21"],
        isValid : function(r) {
          return this.ROLLS.indexOf(r) != -1;
        }
      }

      var player = {
        name : null,
        roll : null,
        announced : null,
        game : null,
        state : null,
        create : function(name, game) {
          var plyr = Object.create(this);
          plyr.name = name;
          plyr.game = game;
          return plyr;
        },
        rollTheDice : function() {
          return "21";
        },
        setCurrentRoll : function(roll) {
          this.roll = roll;
        },
        announce : function(roll) {
          this.announced = roll;
        },
        callBluff : function(otherPlayer) {
          var bluffFoundOut = otherPlayer.hasBluffed();
          this.game.bluffCallHit(this, otherPlayer, bluffFoundOut);
          return bluffFoundOut;
        },
        hasBluffed : function() {
          return this.roll !== this.announced;
        },
        hasWon: function() {
          return this.state === "won";
        },
        youWon: function() {
          this.state = "won";
        },
        youLost: function() {
          this.state = "lost";
        },
        play: function() {

        }
      }

      var game = {
        highestRoll : null,
        players : [],
        playerIndex : 0,
        setHighestRoll : function(roll) {
          this.currentRoll = roll;
        },
        addPlayer : function(player) {
          this.players.push(player);
        },
        nextPlayer : function() {
          return this.players[this.playerIndex];
        },
        playerMoved : function() {
          this.playerIndex = (this.playerIndex + 1) % this.players.length;
        },
        bluffCallHit : function(caller, called, result) {
          if ( result ) {
            caller.youWon();
            called.youLost();
          }
          else {
            called.youWon();
            caller.youLost();
          }
        },
        play : function() {
          console.log("Game.play");
          this.nextPlayer().play();
          this.playerMoved();
        }
      }
      $(document).ready(function(){
        test("dice.roll", function() {
          // Check that in a series of 5 dice rolls, none is outside the (1..6) range
          // Can this be made in a simpler way?
          var invalidRolls = $.grep((1).upto(5), function(_, i){
            var r = dice.roll();
            return r >= 1 && r <= 6;
          }, true)
          ok( invalidRolls.length == 0, "roll is a number between 1 and 6")
        });

        test("roll.isValid", function(){
          equal( roll.isValid("32"), true, "32 is a valid roll");
          equal( roll.isValid("23"), false, "23 is not a valid roll, the bigger number has to be put first");
        });

        test("player.rollTheDice", function() {
          var validDiceRolls = $.grep((1).upto(5), function(_, i){
            var r = player.rollTheDice();
            return roll.isValid(r)
          })
          equal(validDiceRolls.length, 5, "a dice roll is between 32 and 21")
        })

        test("taking turns", function(){
          var theGame = Object.create(game);
          var playerOne = player.create("Alice", theGame);
          var playerTwo = player.create("Bob", theGame);
          theGame.addPlayer(playerOne);
          theGame.addPlayer(playerTwo);
          ok( theGame.nextPlayer() === playerOne, "first player is first");
          // hmm, that dies with a Max. recursion depth exceeded
          // equal( theGame.nextPlayer(), playerOne, "first player is first");
          theGame.play();
          ok( theGame.nextPlayer() === playerTwo, "then comes the second");
        })

        test("winning when bluff unduly called", function(){
          var theGame = Object.create(game);
          var playerOne = player.create("Alice", theGame);
          var playerTwo = player.create("Bob", theGame);
          theGame.setHighestRoll("43");
          playerOne.setCurrentRoll("22");
          playerOne.announce("22");
          playerTwo.callBluff(playerOne);
          ok( !playerTwo.hasWon(), "player loses when calling a bluff that wasn't");
          ok( playerOne.hasWon(), "player wins if opponent says he bluffed but he did not");
        });

        test("winning when bluff is found out", function(){
          var theGame = Object.create(game);
          var playerOne = player.create("Alice", theGame);
          var playerTwo = player.create("Bob", theGame);
          theGame.setHighestRoll("43");
          playerOne.setCurrentRoll("41");
          playerOne.announce("22");
          playerTwo.callBluff(playerOne);
          ok( playerTwo.hasWon(), "player wins if says opponent has bluffed and the opponent did");
          ok( !playerOne.hasWon(), "player loses if bluffs and is found out");
        })

      })
    </script>
  </head>
  <body>
    <h1 id="qunit-header">Bluff it</h1>
   <h2 id="qunit-banner"></h2>
   <h2 id="qunit-userAgent"></h2>
   <ol id="qunit-tests"></ol>
  </body>
</html>
